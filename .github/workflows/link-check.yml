name: Link Verification

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - '.vitepress/theme/untils/data.ts'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-pr:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Base Code (Safe Scripts)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base_code

      - name: Checkout PR Code (Unsafe Data)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr_code
          
      - name: Add Friend Link Label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['友链']
            })

      - name: Verify Links
        id: verify
        run: |
          # Use the script from base_code to check diff between base and pr
          node base_code/.github/scripts/verify_links.js base_code/.vitepress/theme/untils/data.ts pr_code/.vitepress/theme/untils/data.ts > output.txt
          cat output.txt
        continue-on-error: true

      - name: Update PR Title
        if: steps.verify.outputs.title
        uses: actions/github-script@v7
        with:
          script: |
            const title = "${{ steps.verify.outputs.title }}";
            // Check if title is valid to avoid empty update
            if (title && title.trim()) {
                github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  title: title
                })
            }

      - name: Label Link Status
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];
            const iconStatus = "${{ steps.verify.outputs.icon_status }}";
            const linkStatus = "${{ steps.verify.outputs.link_status }}";
            
            if (iconStatus === 'ok') labels.push('头像可达');
            else labels.push('头像不可达');
            
            if (linkStatus === 'ok') labels.push('网站可达');
            else labels.push('网站不可达');
            
            if (iconStatus === 'ok' && linkStatus === 'ok') labels.push('URL全部可达');
            
            // Add labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

      - name: Request Ownership Verification
        uses: actions/github-script@v7
        with:
          script: |
            const body = "请在您的网站根目录放置一个名为 `qingyun-verify.txt` 的文件以验证所有权（内容不限）。\n完成后请在此评论回复“准备完毕”以触发验证。";
            
            // Avoid duplicate comments if possible, but for simplicity we comment on every push/update
            // You might want to check existing comments in a real scenario
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['所有权验证进行中']
            });

  verify-ownership:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '准备完毕')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Base Code (Safe Scripts)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          path: base_code

      - name: Get PR Branch SHA
        uses: actions/github-script@v7
        id: get-pr
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pr.data.head.sha;
          result-encoding: string

      - name: Checkout PR Code (Unsafe Data)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-pr.outputs.result }}
          path: pr_code

      - name: Verify Ownership File
        id: verify
        run: |
           # Use safe script to check diff between base and pr
           node base_code/.github/scripts/verify_links.js base_code/.vitepress/theme/untils/data.ts pr_code/.vitepress/theme/untils/data.ts > output.txt
           # We need verify_status specifically
           # Re-exporting verify_status is handled by the script writing to GITHUB_OUTPUT

      - name: Handle Verification Result
        uses: actions/github-script@v7
        with:
          script: |
            const verifyStatus = "${{ steps.verify.outputs.verify_status }}";
            if (verifyStatus === 'ok') {
              // Merge PR
              try {
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    merge_method: 'squash'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: "验证通过，已自动合并。"
                  });
              } catch (error) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: "验证通过，但在合并时遇到错误（可能是冲突或权限不足）：" + error.message
                  });
              }
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "验证失败，未检测到 `qingyun-verify.txt` 文件，请检查后再次回复“准备完毕”。"
              });
            }
